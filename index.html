<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus AI | Global Intelligence Index</title>
<style>
/* UI構造は固定：edited-image.jpgのレイアウトを完全維持 */
:root { --bg: #020617; --panel: rgba(15, 23, 42, 0.9); --accent: #38bdf8; --text: #f8fafc; --muted: #64748b; --border: rgba(255, 255, 255, 0.05); }
body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #020617 100%); }
.nexus-wrapper { display: grid; grid-template-columns: 280px 1fr 340px; height: 100vh; }
.scroll-v { overflow-y: auto; padding: 25px; scrollbar-width: none; }

/* タイトル（隠しコマンド用） */
.brand-title { font-size: 1.8rem; font-weight: 900; color: var(--accent); cursor: pointer; user-select: none; margin-bottom: 30px; }

/* カードデザイン */
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
.card { background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border); border-radius: 16px; padding: 20px; cursor: pointer; position: relative; }
.card:hover { border-color: var(--accent); transform: translateY(-3px); }
.ai-logo { width: 32px; height: 32px; border-radius: 6px; background: #0f172a; margin-bottom: 12px; }
.c-name { font-weight: 800; font-size: 1.1rem; margin: 0; }
.c-price { font-size: 0.75rem; color: #10b981; margin-top: 5px; font-weight: bold; }
.detail-btn { margin-top: 15px; width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 0.75rem; cursor: pointer; }

/* モーダル共通スタイル */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
.modal-content { background: #0f172a; width: 90%; max-width: 650px; padding: 40px; border-radius: 24px; border: 1px solid var(--accent); position: relative; }
.admin-input { width: 100%; background: #020617; border: 1px solid var(--border); color: var(--accent); padding: 15px; border-radius: 10px; font-family: monospace; margin-bottom: 20px; outline: none; }

/* ユーザー用設定ボタン */
.user-settings { position: fixed; bottom: 20px; right: 20px; cursor: pointer; font-size: 1.5rem; opacity: 0.5; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="nexus-wrapper">
  <aside class="sidebar scroll-v">
    <div class="brand-title" id="nexus-logo" onclick="handleLogoClick()">Nexus AI</div>
    <div id="cat-nav"></div>
  </aside>

  <main class="scroll-v">
    <input type="text" id="nexus-search" style="width:100%; padding:16px; border-radius:50px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:white; margin-bottom:30px;" placeholder="Search Intelligence...">
    <div id="nexus-grid" class="grid"></div>
  </main>

  <aside class="sidebar scroll-v" style="border-left:1px solid var(--border);">
    <div id="ins-view"><h3>Select Intelligence</h3></div>
  </aside>
</div>

<div id="admin-modal" class="modal">
  <div class="modal-content">
    <h2 style="margin-top:0;">Terminal Access</h2>
    <div id="pass-section">
      <p>Enter Administrator Passcode:</p>
      <input type="password" id="admin-pass" class="admin-input" placeholder="********">
      <button onclick="checkPass()" style="width:100%; background:var(--accent); border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer;">Authenticate</button>
    </div>
    <div id="control-section" style="display:none;">
      <p>Firebase Web Config (JSON):</p>
      <textarea id="fb-config" class="admin-input" style="height:80px;"></textarea>
      <p>Stream Ingester (Paste JSON List):</p>
      <textarea id="import-data" class="admin-input" style="height:200px;"></textarea>
      <div style="display:flex; gap:10px;">
        <button onclick="saveAdminSettings()" style="flex:1; background:var(--accent); border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer;">Save & Sync</button>
        <button onclick="closeModal('admin-modal')" style="flex:1; background:transparent; border:1px solid var(--border); color:white; padding:15px; border-radius:10px; cursor:pointer;">Exit</button>
      </div>
    </div>
  </div>
</div>

<div id="detail-modal" class="modal">
  <div class="modal-content" style="max-height:85vh; overflow-y:auto;">
    <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:2rem;" onclick="closeModal('detail-modal')">×</span>
    <div id="modal-body"></div>
  </div>
</div>

<div class="user-settings">⚙️</div>

<script>
let clickCount = 0;
let clickTimer;
let db;

// 5回連続タップの判定
function handleLogoClick() {
  clickCount++;
  clearTimeout(clickTimer);
  if (clickCount === 5) {
    document.getElementById("admin-modal").style.display = "flex";
    clickCount = 0;
  }
  clickTimer = setTimeout(() => { clickCount = 0; }, 1000);
}

function checkPass() {
  const pass = document.getElementById("admin-pass").value;
  if (pass === "55533557") {
    document.getElementById("pass-section").style.display = "none";
    document.getElementById("control-section").style.display = "block";
    document.getElementById("fb-config").value = localStorage.getItem("nexus_config") || "";
  } else {
    alert("Unauthorized Access.");
  }
}

function saveAdminSettings() {
  const config = document.getElementById("fb-config").value;
  const data = document.getElementById("import-data").value;
  
  if (config) localStorage.setItem("nexus_config", config);
  
  if (data) {
    try {
      const items = JSON.parse(data);
      const batch = db.batch();
      items.forEach(it => batch.set(db.collection("ai_tools").doc(it.id), it));
      batch.commit().then(() => alert("Nexus Sync Complete."));
    } catch(e) { alert("Invalid JSON Format."); }
  }
  location.reload();
}

// 初期化と起動
const savedConfig = localStorage.getItem("nexus_config");
if (savedConfig) {
  firebase.initializeApp(JSON.parse(savedConfig));
  db = firebase.firestore();
  fetchData();
}

async function fetchData() {
  const snap = await db.collection("ai_tools").get();
  const nexusData = [];
  snap.forEach(doc => nexusData.push({ id: doc.id, ...doc.data() }));
  render(nexusData);
}

function render(data) {
  const grid = document.getElementById("nexus-grid");
  grid.innerHTML = data.map(it => {
    const icon = it.favicon_domain ? `https://www.google.com/s2/favicons?sz=128&domain=${it.favicon_domain}` : `https://ui-avatars.com/api/?name=${it.name}`;
    return `
    <div class="card">
      <img src="${icon}" class="ai-logo">
      <h3 class="c-name">${it.name}</h3>
      <div class="c-price">${(it.pricing && it.pricing[0]) ? it.pricing[0].price : 'N/A'}</div>
      <button class="detail-btn" onclick="openDetail('${it.id}')">View Detail</button>
    </div>`;
  }).join("");
  window.currentData = data;
}

function openDetail(id) {
  const it = window.currentData.find(x => x.id === id);
  const body = document.getElementById("modal-body");
  body.innerHTML = `
    <div style="display:flex; align-items:center; gap:20px; margin-bottom:25px;">
      <img src="https://www.google.com/s2/favicons?sz=128&domain=${it.favicon_domain}" style="width:64px; border-radius:12px;">
      <h2 style="margin:0;">${it.name}</h2>
    </div>
    <div style="line-height:1.8; color:#d1d5db; margin-bottom:30px;">${it.detail_en || it.short_desc}</div>
    <a href="${it.url}" target="_blank" style="display:block; background:var(--accent); color:#020617; text-align:center; padding:18px; border-radius:12px; font-weight:900; text-decoration:none;">Access Provider</a>
  `;
  document.getElementById("detail-modal").style.display = "flex";
}

function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
